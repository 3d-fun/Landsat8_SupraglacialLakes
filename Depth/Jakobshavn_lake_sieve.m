%Removes small lakes (<5 pixels) and linear features

%Define directory where Landsat scene folders are stored
directory = ' /Volumes/ELEMENTS/SermeqKujalleq2015/HighRez/';

%"Lakes" must be at least 5 pixels total
min_pixel = 5;

%"Lakes" must be wider and/or taller than 1 pixels
min_width = 1;

%Create list of all Landsat scenes to be used 
    %(I included notes about the%masks used to clean these manually later)
    %These were edited manually for Northwest Scenes
Scenes = {'LC80060122015166LGN00'; ... Notes
'LC80060122015182LGN00'; ...
'LC80060122015198LGN00'; ...
'LC80060122015214LGN00'; ...
'LC80060132015166LGN00'; ...
'LC80060132015182LGN00'; ...
'LC80060132015198LGN00'; ...
'LC80060132015214LGN00'; ...
'LC80060132015230LGN00'; ...
'LC80060142015166LGN00'; ...
'LC80060142015182LGN00'; ...
'LC80060142015198LGN00'; ...
'LC80060142015214LGN00'; ...
'LC80060152015166LGN00'; ...
'LC80060152015182LGN00'; ...
'LC80060152015198LGN00'; ...
'LC80060152015214LGN00'; ...
'LC80070122015189LGN00'; ...
'LC80070122015237LGN00'; ...
'LC80070132015189LGN00'; ...
'LC80070132015205LGN01'; ...
'LC80070132015237LGN00'; ...
'LC80070132015253LGN00'; ...
'LC80070142015189LGN00'; ...
'LC80070142015205LGN01'; ...
'LC80070142015237LGN00'; ...
'LC80070142015253LGN00'; ...
'LC80080112015180LGN00'; ...
'LC80080112015196LGN00'; ...
'LC80080112015212LGN00'; ...
'LC80080112015228LGN00'; ...
'LC80080122015164LGN00'; ...
'LC80080122015180LGN00'; ...
'LC80080122015196LGN00'; ...
'LC80080122015212LGN00'; ...
'LC80090112015155LGN00'; ...
'LC80090112015187LGN00'; ...
'LC80090112015235LGN00'; ...
'LC80090112015251LGN00'; ...
'LC80090122015155LGN00'; ...
'LC80090122015171LGN00'; ...
'LC80090122015187LGN00'; ...
'LC80090122015235LGN00'; ...
'LC80090122015251LGN00'; ...
'LC80100112015162LGN00'; ...
'LC80100112015194LGN00'; ...
'LC80100112015210LGN00'; ...
'LC80100112015226LGN00'};

home = pwd ;
addpath(pwd);

for scene = 1:size(Scenes,1);
    %change to appropriate directory
    expression = strcat('cd ',directory,Scenes{scene},'/');
    eval(expression);
    
    %read in Lake Mask
    expression = strcat('[mask, mask_info] = geotiffread(''',Scenes{scene},'_lake_mask.tif'');');
    eval(expression);
    expression = strcat('mask_tiffinfo = geotiffinfo(''',Scenes{scene},'_lake_mask.tif'');');
    eval(expression);

    %remove "small" lakes
    CC = bwconncomp(mask,4);
    for lake = 1:CC.NumObjects
        if size(CC.PixelIdxList{lake},1) < min_pixel
            mask(CC.PixelIdxList{lake}) = 0;
        else %all same row or all same column
            [r,c] = ind2sub(size(mask),CC.PixelIdxList{lake});
            r = unique(r);
            c = unique(c);
            if size(r,1) == min_width || size(c,1) == min_width;
                mask(CC.PixelIdxList{lake}) = 0;
            end
        end
    end
    
    %write mask_sieve
    expression = strcat('geotiffwrite(''',Scenes{scene},'_lake_mask_sieve.tif'', mask, mask_info, ''GeoKeyDirectoryTag'',mask_tiffinfo.GeoTIFFTags.GeoKeyDirectoryTag);');
    eval(expression)
    
    clear mask mask_info mask_tiffinfo CC lake expression r c
end

expression = strcat('cd ''',home,'''');
eval(expression)

clear home Scenes scene expression